
  <!DOCTYPE html>


<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<meta name="description" content="Instructions for setting up the Modbus Controller component.">
<meta itemprop="name" content="Modbus Controller">
<meta itemprop="description" content="Instructions for setting up the Modbus Controller component.">
<meta itemprop="image" content="https://esphome.io/_images/modbus.png">
<meta name="twitter:title" content="Modbus Controller">
<meta name="twitter:image:src" content="https://esphome.io/_images/modbus.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@OttoWinter_">
<meta name="twitter:description" content="Instructions for setting up the Modbus Controller component.">
<meta property="og:title" content="Modbus Controller">
<meta property="og:image" content="https://esphome.io/_images/modbus.png">
<meta property="og:type" content="website">
<meta property="og:description" content="Instructions for setting up the Modbus Controller component.">

    <title>Modbus Controller &#8212; ESPHome</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../_static/pygments_dark.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="canonical" href="https://esphome.io/components/modbus_controller.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MQTT Client Component" href="mqtt.html" />
    <link rel="prev" title="Modbus Component" href="modbus.html" />
  <link rel="stylesheet" href="../_static/custom.css?hash=ab494674" type="text/css" />
  <link rel="apple-touch-icon" sizes="180x180" href="/_static/apple-touch-icon.png">
  <link rel="shortcut icon" href="/_static/favicon.ico">
  <link rel="icon" type="image/png" sizes="512x512" href="/_static/favicon-512x512.png">
  <link rel="icon" type="image/png" sizes="256x256" href="/_static/favicon-256x256.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/_static/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="128x128" href="/_static/favicon-128x128.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/_static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/_static/favicon-16x16.png">
  <link rel="manifest" href="/_static/site.webmanifest">
  <link rel="mask-icon" href="/_static/safari-pinned-tab.svg" color="#646464">
  <meta name="apple-mobile-web-app-title" content="ESPHome">
  <meta name="application-name" content="ESPHome">
  <meta name="msapplication-TileColor" content="#dfdfdf">
  <meta name="msapplication-config" content="/_static/browserconfig.xml">
  <meta name="theme-color" content="#dfdfdf">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta property="og:site_name" content="ESPHome">
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo-text.svg" alt="Logo"/>
            </a></p><link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>

<div id="search"></div>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
</script>

  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Modbus Controller</a><ul>
<li><a class="reference internal" href="#hardware-setup">Hardware setup</a></li>
<li><a class="reference internal" href="#configuration-variables">Configuration variables:</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
<li><a class="reference internal" href="#bitmasks">Bitmasks</a></li>
<li><a class="reference internal" href="#protocol-decoding-example">Protocol decoding example</a></li>
<li><a class="reference internal" href="#note">Note</a></li>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>

  </div><hr />
<ul>
    <li><a href="https://discord.gg/KhAMKrd" target="_blank">Join the community</a></li>
    <li><a href="https://twitter.com/esphome_" target="_blank">Follow us on Twitter</a></li>
    <li><a href="https://github.com/esphome/esphome" target="_blank">Source Code</a></li>
    <li><a href="mailto:esphome@nabucasa.com">Contact</a> (no support!)</li>
</ul>
ESPHome is an open source project by <a href="https://www.nabucasa.com" target="_blank">Nabu Casa</a>
<ul>
    <li><a href="https://www.netlify.com" target="_blank">This site is powered by Netlify</a></li>
</ul>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
  
  <ul class="breadcrumbs">
      <li><a href="index.html">Components</a> ➔</li>
      <li>Modbus Controller</li>
  </ul>
  


          <div class="body" role="main">
            
  <section id="modbus-controller">
<h1>Modbus Controller<a class="headerlink" href="#modbus-controller" title="Permalink to this heading">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">modbus_controller</span></code> component creates a RS485 connection to control a modbus device</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/modbus.png"><img alt="../_images/modbus.png" src="../_images/modbus.png" style="width: 25%;" /></a>
</figure>
<p>The <code class="docutils literal notranslate"><span class="pre">modbus_controller</span></code> component uses the modbus component</p>
<section id="hardware-setup">
<h2>Hardware setup<a class="headerlink" href="#hardware-setup" title="Permalink to this heading">¶</a></h2>
<p>A RS 485 module connected to an ESP32, for example:</p>
<figure class="align-default">
<img alt="../_images/rs485.jpg" src="../_images/rs485.jpg" />
</figure>
<p>See <a class="reference external" href="https://electronics.stackexchange.com/questions/244425/how-is-this-rs485-module-working">How is this RS485 Module Working?</a> on stackexchange for more details</p>
<p>The controller connects to the UART of the MCU. For ESP32  GPIO PIN 16 to TXD PIN 17 to RXD are the default ports but any other pins can be used as well. 3.3V to VCC and GND to GND.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are using an ESP8266, serial logging may cause problems reading from UART. For best results, hardware serial is recommended. Software serial may not be able to read all received data if other components spend a lot of time in the <code class="docutils literal notranslate"><span class="pre">loop()</span></code>.</p>
<p>For hardware serial only a limited set of pins can be used. Either <code class="docutils literal notranslate"><span class="pre">tx_pin:</span> <span class="pre">GPIO1</span></code> and <code class="docutils literal notranslate"><span class="pre">rx_pin:</span> <span class="pre">GPIO3</span></code>  or <code class="docutils literal notranslate"><span class="pre">tx_pin:</span> <span class="pre">GPIO15</span></code> and <code class="docutils literal notranslate"><span class="pre">rx_pin:</span> <span class="pre">GPIO13</span></code>.</p>
<p>The disadvantage of using the hardware uart is that you can’t use serial logging because the serial logs would be sent to the modbus device and cause errors.</p>
<p>Serial logging can be disabled by setting <code class="docutils literal notranslate"><span class="pre">baud_rate:</span> <span class="pre">0</span></code>.</p>
<p>See <a class="reference internal" href="logger.html"><span class="doc">Logger Component</span></a> for more details</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">logger</span><span class="p">:</span>
<span class="w">    </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;level&gt;</span>
<span class="w">    </span><span class="nt">baud_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</pre></div>
</div>
</div>
</section>
<section id="configuration-variables">
<h2>Configuration variables:<a class="headerlink" href="#configuration-variables" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><strong>modbus_id</strong> (<em>Optional</em>, <a class="reference internal" href="../guides/configuration-types.html#config-id"><span class="std std-ref">ID</span></a>): Manually specify the ID of the modbus hub.</p></li>
<li><p><strong>address</strong> (<strong>Required</strong>, <a class="reference internal" href="../guides/configuration-types.html#config-id"><span class="std std-ref">ID</span></a>): The modbus address of the device
Specify the modbus device address of the.</p></li>
<li><p><strong>command_throttle</strong> (<em>Optional</em>, <a class="reference internal" href="../guides/configuration-types.html#config-time"><span class="std std-ref">Time</span></a>): minimum time in between 2 requests to the device. Default is 0ms
Because some modbus devices limit the rate of requests the interval between sending requests to the device can be modified.</p></li>
<li><p><strong>update_interval</strong> (<em>Optional</em>, <a class="reference internal" href="../guides/configuration-types.html#config-time"><span class="std std-ref">Time</span></a>): The interval that the sensors should be checked.
Defaults to 60 seconds.</p></li>
</ul>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h2>
<p>The following code create a modbus_controller hub talking to a modbus device at address 1 with 115200 bps</p>
<p>Modbus sensors can be directly defined (inline) under the modbus_controller hub or as standalone components
Technically there is no difference between the “inline” and the standard definitions approach.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">uart</span><span class="p">:</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mod_bus</span>
<span class="w">  </span><span class="nt">tx_pin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">17</span>
<span class="w">  </span><span class="nt">rx_pin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">16</span>
<span class="w">  </span><span class="nt">baud_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">115200</span>
<span class="w">  </span><span class="nt">stop_bits</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>

<span class="nt">modbus</span><span class="p">:</span>
<span class="w">  </span><span class="nt">flow_control_pin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus1</span>

<span class="nt">modbus_controller</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="c1">## the Modbus device addr</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x1</span>
<span class="w">    </span><span class="nt">modbus_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus1</span>
<span class="w">    </span><span class="nt">setup_priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-10</span>

<span class="nt">text_sensor</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rtc_clock&quot;</span>
<span class="w">    </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rtc_clock</span>
<span class="w">    </span><span class="nt">internal</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">holding</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x9013</span>
<span class="w">    </span><span class="nt">register_count</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">    </span><span class="nt">raw_encode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HEXBYTES</span>
<span class="w">    </span><span class="nt">response_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6</span>

<span class="nt">switch</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reset_to_fabric_default</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Reset</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">Factory</span><span class="nv"> </span><span class="s">Default&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coil</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x15</span>
<span class="w">    </span><span class="nt">bitmask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>

<span class="nt">sensor</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Battery</span><span class="nv"> </span><span class="s">Capacity&quot;</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">battery_capacity</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">holding</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x9001</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;AH&quot;</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_WORD</span>
</pre></div>
</div>
</section>
<section id="bitmasks">
<h2>Bitmasks<a class="headerlink" href="#bitmasks" title="Permalink to this heading">¶</a></h2>
<p>Some devices use decimal values in read registers to show multiple binary states occupying only one register address. To decode them, you can use bitmasks according to the table below. The decimal value corresponding to a bit is always double of the previous one in the row. Multiple bits can be represented in a single register by making a sum of all the values corresponding to the bits.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Alarm  bit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>DEC value</p></th>
<th class="head"><p>HEX value</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>bit 0</p></td>
<td><p>Binary Sensor 0</p></td>
<td><p>1</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>bit 1</p></td>
<td><p>Binary Sensor 1</p></td>
<td><p>2</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>bit 2</p></td>
<td><p>Binary Sensor 2</p></td>
<td><p>4</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-odd"><td><p>bit 3</p></td>
<td><p>Binary Sensor 3</p></td>
<td><p>8</p></td>
<td><p>8</p></td>
</tr>
<tr class="row-even"><td><p>bit 4</p></td>
<td><p>Binary Sensor 4</p></td>
<td><p>16</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p>bit 5</p></td>
<td><p>Binary Sensor 5</p></td>
<td><p>32</p></td>
<td><p>20</p></td>
</tr>
<tr class="row-even"><td><p>bit 6</p></td>
<td><p>Binary Sensor 6</p></td>
<td><p>64</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-odd"><td><p>bit 7</p></td>
<td><p>Binary Sensor 7</p></td>
<td><p>128</p></td>
<td><p>80</p></td>
</tr>
<tr class="row-even"><td><p>bit 8</p></td>
<td><p>Binary Sensor 8</p></td>
<td><p>256</p></td>
<td><p>100</p></td>
</tr>
<tr class="row-odd"><td><p>bit 9</p></td>
<td><p>Binary Sensor 9</p></td>
<td><p>512</p></td>
<td><p>200</p></td>
</tr>
<tr class="row-even"><td><p>bit 10</p></td>
<td><p>Binary Sensor 10</p></td>
<td><p>1024</p></td>
<td><p>400</p></td>
</tr>
<tr class="row-odd"><td><p>bit 11</p></td>
<td><p>Binary Sensor 11</p></td>
<td><p>2048</p></td>
<td><p>800</p></td>
</tr>
<tr class="row-even"><td><p>bit 12</p></td>
<td><p>Binary Sensor 12</p></td>
<td><p>4096</p></td>
<td><p>1000</p></td>
</tr>
<tr class="row-odd"><td><p>bit 13</p></td>
<td><p>Binary Sensor 13</p></td>
<td><p>8192</p></td>
<td><p>2000</p></td>
</tr>
<tr class="row-even"><td><p>bit 14</p></td>
<td><p>Binary Sensor 14</p></td>
<td><p>16384</p></td>
<td><p>4000</p></td>
</tr>
<tr class="row-odd"><td><p>bit 15</p></td>
<td><p>Binary Sensor 15</p></td>
<td><p>32768</p></td>
<td><p>8000</p></td>
</tr>
</tbody>
</table>
<p>For example, when reading register <code class="docutils literal notranslate"><span class="pre">15</span></code>, a decimal value of <code class="docutils literal notranslate"><span class="pre">12288</span></code> is the sum of <code class="docutils literal notranslate"><span class="pre">4096</span></code> + <code class="docutils literal notranslate"><span class="pre">8192</span></code>, meaning the corresponding bits <code class="docutils literal notranslate"><span class="pre">12</span></code> and <code class="docutils literal notranslate"><span class="pre">13</span></code> are <code class="docutils literal notranslate"><span class="pre">1</span></code>, the other bits are <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<p>To gather some of these bits as binary sensors in ESPHome, use <code class="docutils literal notranslate"><span class="pre">bitmask</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">binary_sensor</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">  </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ventilation_system</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Alarm bit0</span>
<span class="w">  </span><span class="nt">entity_category</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">diagnostic</span>
<span class="w">  </span><span class="nt">device_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">problem</span>
<span class="w">  </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
<span class="w">  </span><span class="nt">bitmask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x1</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">  </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ventilation_system</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Alarm bit1</span>
<span class="w">  </span><span class="nt">entity_category</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">diagnostic</span>
<span class="w">  </span><span class="nt">device_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">problem</span>
<span class="w">  </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
<span class="w">  </span><span class="nt">bitmask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x2</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">  </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ventilation_system</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Alarm bit10</span>
<span class="w">  </span><span class="nt">entity_category</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">diagnostic</span>
<span class="w">  </span><span class="nt">device_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">problem</span>
<span class="w">  </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
<span class="w">  </span><span class="nt">bitmask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x400</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">  </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ventilation_system</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Alarm bit15</span>
<span class="w">  </span><span class="nt">entity_category</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">diagnostic</span>
<span class="w">  </span><span class="nt">device_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">problem</span>
<span class="w">  </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">  </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
<span class="w">  </span><span class="nt">bitmask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x8000</span>
</pre></div>
</div>
</section>
<section id="protocol-decoding-example">
<h2>Protocol decoding example<a class="headerlink" href="#protocol-decoding-example" title="Permalink to this heading">¶</a></h2>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">sensors</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array_rated_voltage</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;array_rated_voltage&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3000</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;V&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_WORD</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">skip_updates</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">multiply</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array_rated_current</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;array_rated_current&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3001</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;V&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_WORD</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">multiply</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array_rated_power</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;array_rated_power&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3002</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;W&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_DWORD_R</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">multiply</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>

<span class="w">  </span><span class="nt">-platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller_id</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">battery_rated_voltage</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="s">&quot;battery_rated_voltage&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3004</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;V&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_WORD</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">multiply</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">battery_rated_current</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;battery_rated_current&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3005</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;A&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_WORD</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">multiply</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">battery_rated_power</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;battery_rated_power&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3006</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;W&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_DWORD_R</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">multiply</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id: epever id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">charging_mode</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;charging_mode&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3008</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_WORD</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</pre></div>
</div>
<p>To minimize the required transactions all registers with the same base address are read in one request.
The response is mapped to the sensor based on register_count and offset in bytes.</p>
<p><strong>Request</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>data</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0x1  (01)</p></td>
<td><p>device address</p></td>
</tr>
<tr class="row-odd"><td><p>0x4  (04)</p></td>
<td><p>function code 4 (Read Input Registers)</p></td>
</tr>
<tr class="row-even"><td><p>0x30 (48)</p></td>
<td><p>start address high byte</p></td>
</tr>
<tr class="row-odd"><td><p>0x0  (00)</p></td>
<td><p>start address low byte</p></td>
</tr>
<tr class="row-even"><td><p>0x0  (00)</p></td>
<td><p>number of registers to read high byte</p></td>
</tr>
<tr class="row-odd"><td><p>0x9  (09)</p></td>
<td><p>number of registers to read low byte</p></td>
</tr>
<tr class="row-even"><td><p>0x3f (63)</p></td>
<td><p>crc</p></td>
</tr>
<tr class="row-odd"><td><p>0xc  (12)</p></td>
<td><p>crc</p></td>
</tr>
</tbody>
</table>
<p><strong>Response</strong></p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>offset</p></th>
<th class="head"><p>data</p></th>
<th class="head"><p>value (type)</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>H</p></td>
<td><p>0x1  (01)</p></td>
<td></td>
<td><p>device address</p></td>
</tr>
<tr class="row-odd"><td><p>H</p></td>
<td><p>0x4  (04)</p></td>
<td></td>
<td><p>function code</p></td>
</tr>
<tr class="row-even"><td><p>H</p></td>
<td><p>0x12 (18)</p></td>
<td></td>
<td><p>byte count</p></td>
</tr>
<tr class="row-odd"><td><p>0</p></td>
<td><p>0x27 (39)</p></td>
<td><p>U_WORD</p></td>
<td><p>array_rated_voltage  high byte</p></td>
</tr>
<tr class="row-even"><td><p>1</p></td>
<td><p>0x10 (16)</p></td>
<td><p>0x2710 (100000)</p></td>
<td><p>array_rated_voltage  low byte</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>0x7  (7)</p></td>
<td><p>U_WORD</p></td>
<td><p>array_rated_current  high byte</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>0xd0 (208)</p></td>
<td><p>0x7d0 (2000)</p></td>
<td><p>array_rated_current  low byte</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>0xcb (203)</p></td>
<td><p>U_DWORD_R</p></td>
<td><p>array_rated_power high byte of low word</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>0x20 (32)</p></td>
<td><p>spans 2 register</p></td>
<td><p>array_rated_power low byte of low word</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>0x0  (0)</p></td>
<td></td>
<td><p>array_rated_power high byte of high word</p></td>
</tr>
<tr class="row-even"><td><p>7</p></td>
<td><p>0x0  (0)</p></td>
<td><p>0x0000CB20 (52000)</p></td>
<td><p>array_rated_power low byte of high word</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>0x9  (09)</p></td>
<td><p>U_WORD</p></td>
<td><p>battery_rated_voltage high byte</p></td>
</tr>
<tr class="row-even"><td><p>9</p></td>
<td><p>0x60 (96)</p></td>
<td><p>0x960 (2400)</p></td>
<td><p>battery_rated_voltage low byte</p></td>
</tr>
<tr class="row-odd"><td><p>10</p></td>
<td><p>0x7  (07)</p></td>
<td><p>U_WORD</p></td>
<td><p>battery_rated_current high word</p></td>
</tr>
<tr class="row-even"><td><p>11</p></td>
<td><p>0xd0 (208)</p></td>
<td><p>0x7d0 (2000)</p></td>
<td><p>battery_rated_current high word</p></td>
</tr>
<tr class="row-odd"><td><p>12</p></td>
<td><p>0xcb (203)</p></td>
<td><p>U_DWORD_R</p></td>
<td><p>battery_rated_power high byte of low word</p></td>
</tr>
<tr class="row-even"><td><p>13</p></td>
<td><p>0x20 (32)</p></td>
<td><p>spans 2 register</p></td>
<td><p>battery_rated_power low byte of low word</p></td>
</tr>
<tr class="row-odd"><td><p>14</p></td>
<td><p>0x0  (0)</p></td>
<td></td>
<td><p>battery_rated_power high byte of high word</p></td>
</tr>
<tr class="row-even"><td><p>15</p></td>
<td><p>0x0  (0)</p></td>
<td><p>0x0000CB20 (52000)</p></td>
<td><p>battery_rated_power low byte of high word</p></td>
</tr>
<tr class="row-odd"><td><p>16</p></td>
<td><p>0x0  (0)</p></td>
<td><p>U_WORD</p></td>
<td><p>charging_mode high byte</p></td>
</tr>
<tr class="row-even"><td><p>17</p></td>
<td><p>0x2  (02)</p></td>
<td><p>0x2 (MPPT)</p></td>
<td><p>charging_mode low  byte</p></td>
</tr>
<tr class="row-odd"><td><p>C</p></td>
<td><p>0x2f (47)</p></td>
<td></td>
<td><p>crc</p></td>
</tr>
<tr class="row-even"><td><p>C</p></td>
<td><p>0x31 (49)</p></td>
<td></td>
<td><p>crc</p></td>
</tr>
</tbody>
</table>
</section>
<section id="note">
<h2>Note<a class="headerlink" href="#note" title="Permalink to this heading">¶</a></h2>
<p>Write support is only implemented for switches and selects.
However the C++ code provides the required API to write to a modbus device.</p>
<p>These methods can be called from a lambda.</p>
<p>Here is an example how to set config values to for an EPEVER Trace AN controller.
The code synchronizes the localtime of MCU to the epever controller
The time is set by writing 12 bytes to register 0x9013.
Then battery charge settings are sent.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">esphome</span><span class="p">:</span>
<span class="w">  </span><span class="nt">on_boot</span><span class="p">:</span>
<span class="w">    </span><span class="c1">## configure controller settings at setup</span>
<span class="w">    </span><span class="c1">## make sure priority is lower than setup_priority of modbus_controller</span>
<span class="w">    </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-100</span>
<span class="w">    </span><span class="nt">then</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">          </span><span class="no">// get local time and sync to controller</span>
<span class="w">          </span><span class="no">time_t now = ::time(nullptr);</span>
<span class="w">          </span><span class="no">struct tm *time_info = ::localtime(&amp;now);</span>
<span class="w">          </span><span class="no">int seconds = time_info-&gt;tm_sec;</span>
<span class="w">          </span><span class="no">int minutes = time_info-&gt;tm_min;</span>
<span class="w">          </span><span class="no">int hour = time_info-&gt;tm_hour;</span>
<span class="w">          </span><span class="no">int day = time_info-&gt;tm_mday;</span>
<span class="w">          </span><span class="no">int month = time_info-&gt;tm_mon + 1;</span>
<span class="w">          </span><span class="no">int year = time_info-&gt;tm_year % 100;</span>
<span class="w">          </span><span class="no">esphome::modbus_controller::ModbusController *controller = id(epever);</span>
<span class="w">          </span><span class="no">// if there is no internet connection localtime returns year 70</span>
<span class="w">          </span><span class="no">if (year != 70) {</span>
<span class="w">            </span><span class="no">// create the payload</span>
<span class="w">            </span><span class="no">std::vector&lt;uint16_t&gt; rtc_data = {uint16_t((minutes &lt;&lt; 8) | seconds), uint16_t((day &lt;&lt; 8) | hour),</span>
<span class="w">                                              </span><span class="no">uint16_t((year &lt;&lt; 8) | month)};</span>
<span class="w">            </span><span class="no">// Create a modbus command item with the time information as the payload</span>
<span class="w">            </span><span class="no">esphome::modbus_controller::ModbusCommandItem set_rtc_command =</span>
<span class="w">                </span><span class="no">esphome::modbus_controller::ModbusCommandItem::create_write_multiple_command(controller, 0x9013, 3, rtc_data);</span>
<span class="w">            </span><span class="no">// Submit the command to the send queue</span>
<span class="w">            </span><span class="no">epever-&gt;queue_command(set_rtc_command);</span>
<span class="w">            </span><span class="no">ESP_LOGI(&quot;ModbusLambda&quot;, &quot;EPSOLAR RTC set to %02d:%02d:%02d %02d.%02d.%04d&quot;, hour, minutes, seconds, day, month,</span>
<span class="w">                    </span><span class="no">year + 2000);</span>
<span class="w">          </span><span class="no">}</span>
<span class="w">          </span><span class="no">// Battery settings</span>
<span class="w">          </span><span class="no">// Note: these values are examples only and apply my AGM Battery</span>
<span class="w">          </span><span class="no">std::vector&lt;uint16_t&gt; battery_settings1 = {</span>
<span class="w">              </span><span class="no">0,       // 9000 Battery Type 0 =  User</span>
<span class="w">              </span><span class="no">0x0073,  // 9001 Battery Cap 0x55 == 115AH</span>
<span class="w">              </span><span class="no">0x012C,  // 9002 Temp compensation -3V /°C/2V</span>
<span class="w">              </span><span class="no">0x05DC,  // 9003 0x5DC == 1500 Over Voltage Disconnect Voltage 15,0</span>
<span class="w">              </span><span class="no">0x058C,  // 9004 0x58C == 1480 Charging Limit Voltage 14,8</span>
<span class="w">              </span><span class="no">0x058C,  // 9005 Over Voltage Reconnect Voltage 14,8</span>
<span class="w">              </span><span class="no">0x05BF,  // 9006 Equalize Charging Voltage 14,6</span>
<span class="w">              </span><span class="no">0x05BE,  // 9007 Boost Charging Voltage 14,7</span>
<span class="w">              </span><span class="no">0x0550,  // 9008 Float Charging Voltage 13,6</span>
<span class="w">              </span><span class="no">0x0528,   // 9009 Boost Reconnect Charging Voltage 13,2</span>
<span class="w">              </span><span class="no">0x04C4,  // 900A Low Voltage Reconnect Voltage 12,2</span>
<span class="w">              </span><span class="no">0x04B0,  // 900B Under Voltage Warning Reconnect Voltage 12,0</span>
<span class="w">              </span><span class="no">0x04BA,  // 900c Under Volt. Warning Volt 12,1</span>
<span class="w">              </span><span class="no">0x04BA,  // 900d Low Volt. Disconnect Volt. 11.8</span>
<span class="w">              </span><span class="no">0x04BA   // 900E Discharging Limit Voltage 11.8</span>
<span class="w">          </span><span class="no">};</span>

<span class="w">          </span><span class="no">// Boost and equalization periods</span>
<span class="w">          </span><span class="no">std::vector&lt;uint16_t&gt; battery_settings2 = {</span>
<span class="w">              </span><span class="no">0x0000,  // 906B Equalize Duration (min.) 0</span>
<span class="w">              </span><span class="no">0x0075   // 906C Boost Duration (aka absorb) 117 mins</span>
<span class="w">          </span><span class="no">};</span>
<span class="w">          </span><span class="no">esphome::modbus_controller::ModbusCommandItem set_battery1_command =</span>
<span class="w">              </span><span class="no">esphome::modbus_controller::ModbusCommandItem::create_write_multiple_command(controller, 0x9000, battery_settings1.size() ,</span>
<span class="w">                                                                                          </span><span class="no">battery_settings1);</span>

<span class="w">          </span><span class="no">esphome::modbus_controller::ModbusCommandItem set_battery2_command =</span>
<span class="w">              </span><span class="no">esphome::modbus_controller::ModbusCommandItem::create_write_multiple_command(controller, 0x906B, battery_settings3.size(),</span>
<span class="w">                                                                                          </span><span class="no">battery_settings2);</span>
<span class="w">          </span><span class="no">delay(200) ;</span>
<span class="w">          </span><span class="no">controller-&gt;queue_command(set_battery1_command);</span>
<span class="w">          </span><span class="no">delay(200) ;</span>
<span class="w">          </span><span class="no">controller-&gt;queue_command(set_battery2_command);</span>
<span class="w">          </span><span class="no">ESP_LOGI(&quot;ModbusLambda&quot;, &quot;EPSOLAR Battery set&quot;);</span>

<span class="nt">uart</span><span class="p">:</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mod_bus</span>
<span class="w">  </span><span class="nt">tx_pin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">19</span>
<span class="w">  </span><span class="nt">rx_pin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">18</span>
<span class="w">  </span><span class="nt">baud_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">115200</span>
<span class="w">  </span><span class="nt">stop_bits</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>

<span class="nt">modbus</span><span class="p">:</span>
<span class="w">  </span><span class="c1">#flow_control_pin: 23</span>
<span class="w">  </span><span class="nt">send_wait_time</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200ms</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mod_bus_epever</span>

<span class="nt">modbus_controller</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="c1">## the Modbus device addr</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x1</span>
<span class="w">    </span><span class="nt">modbus_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mod_bus_epever</span>
<span class="w">    </span><span class="nt">command_throttle</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0ms</span>
<span class="w">    </span><span class="nt">setup_priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-10</span>
<span class="w">    </span><span class="nt">update_interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${updates}</span>

<span class="nt">sensor</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array_rated_voltage</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;array_rated_voltage&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3000</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;V&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_WORD</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">multiply</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array_rated_current</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;array_rated_current&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3001</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;A&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_WORD</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">multiply</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modbus_controller</span>
<span class="w">    </span><span class="nt">modbus_controller_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">epever</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">array_rated_power</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;array_rated_power&quot;</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x3002</span>
<span class="w">    </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;W&quot;</span>
<span class="w">    </span><span class="nt">register_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">read</span>
<span class="w">    </span><span class="nt">value_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">U_DWORD_R</span>
<span class="w">    </span><span class="nt">accuracy_decimals</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">filters</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">multiply</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>
</pre></div>
</div>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="sensor/modbus_controller.html"><span class="doc">Modbus Controller Sensor</span></a></p></li>
<li><p><a class="reference internal" href="binary_sensor/modbus_controller.html"><span class="doc">Modbus Controller Binary Sensor</span></a></p></li>
<li><p><a class="reference internal" href="text_sensor/modbus_controller.html"><span class="doc">Modbus Controller Text Sensor</span></a></p></li>
<li><p><a class="reference internal" href="switch/modbus_controller.html"><span class="doc">Modbus Controller Switch</span></a></p></li>
<li><p><a class="reference internal" href="number/modbus_controller.html"><span class="doc">Modbus Controller Number</span></a></p></li>
<li><p><a class="reference internal" href="output/modbus_controller.html"><span class="doc">Modbus Controller Output</span></a></p></li>
<li><p><a class="reference external" href="https://devices.esphome.io/devices/epever_mptt_tracer_an">EPEVER MPPT Solar Charge Controller (Tracer-AN Series)</a></p></li>
<li><p><a class="reference external" href="https://www.modbustools.com/modbus.html">Modbus RTU Protocol Description</a></p></li>
<li><p><a class="reference external" href="https://github.com/esphome/esphome-docs/blob/current/components/modbus_controller.rst">Edit this page on GitHub</a></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
  <div id="upgrade-footer">
    A new version has been release since you last visited this page: 2023.8.3 🎉
    <div class="footer-button-container">
      <div role="button" id="upgrade-footer-dismiss" class="footer-button">Dismiss</div>
      <a id="upgrade-footer-changelog" class="footer-button" href="/changelog/2023.8.0.html">View Changelog</a>
    </div>
  </div>
  <script>
    var old = window.localStorage.getItem("version");
    if (old === null || window.location.pathname.lastIndexOf("/changelog/", 0) === 0) { window.localStorage.setItem("version", "2023.8");
    } else if (old !== "2023.8") {
      const footerEl = document.getElementById("upgrade-footer");
      footerEl.classList.add("not-hidden");
      footerEl.addEventListener('click', function () {
        window.localStorage.setItem("version", "2023.8");
        footerEl.classList.remove("not-hidden");
      });
    }
  </script>

  </body>
</html>