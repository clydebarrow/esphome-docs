
  <!DOCTYPE html>


<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />
<meta name="description" content="Recipes for various interesting things you can do with Lambdas in ESPHome">
<meta itemprop="name" content="Lambda Magic">
<meta itemprop="description" content="Recipes for various interesting things you can do with Lambdas in ESPHome">
<meta itemprop="image" content="https://clydebarrow.github.io/esphome-docs/_images/language-cpp.png">
<meta name="twitter:title" content="Lambda Magic">
<meta name="twitter:image:src" content="https://clydebarrow.github.io/esphome-docs/_images/language-cpp.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@OttoWinter_">
<meta name="twitter:description" content="Recipes for various interesting things you can do with Lambdas in ESPHome">
<meta property="og:title" content="Lambda Magic">
<meta property="og:image" content="https://clydebarrow.github.io/esphome-docs/_images/language-cpp.png">
<meta property="og:type" content="website">
<meta property="og:description" content="Recipes for various interesting things you can do with Lambdas in ESPHome">

    <title>Lambda Magic &#8212; ESPHome</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link id="pygments_dark_css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css" href="../_static/pygments_dark.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="canonical" href="https://clydebarrow.github.io/esphome-docs/cookbook/lambda_magic.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ESP32 Water Leak Detector (with notification)" href="leak-detector-m5stickC.html" />
    <link rel="prev" title="Infostripe" href="infostrip.html" />
  <link rel="stylesheet" href="../_static/custom.css?hash=ab494674" type="text/css" />
  <link rel="apple-touch-icon" sizes="180x180" href="_static/apple-touch-icon.png">
  <link rel="shortcut icon" href="_static/favicon.ico">
  <link rel="icon" type="image/png" sizes="512x512" href="_static/favicon-512x512.png">
  <link rel="icon" type="image/png" sizes="256x256" href="_static/favicon-256x256.png">
  <link rel="icon" type="image/png" sizes="192x192" href="_static/favicon-192x192.png">
  <link rel="icon" type="image/png" sizes="128x128" href="_static/favicon-128x128.png">
  <link rel="icon" type="image/png" sizes="32x32" href="_static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="_static/favicon-16x16.png">
  <link rel="manifest" href="_static/site.webmanifest">
  <link rel="mask-icon" href="_static/safari-pinned-tab.svg" color="#646464">
  <meta name="apple-mobile-web-app-title" content="ESPHome">
  <meta name="application-name" content="ESPHome">
  <meta name="msapplication-TileColor" content="#dfdfdf">
  <meta name="msapplication-config" content="_static/browserconfig.xml">
  <meta name="theme-color" content="#dfdfdf">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta property="og:site_name" content="ESPHome">
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo-text.svg" alt="Logo"/>
            </a></p><link href="pagefind/pagefind-ui.css" rel="stylesheet">
<script src="pagefind/pagefind-ui.js"></script>

<div id="search"></div>
<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#search", showSubResults: true });
    });
</script>

  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Lambda Magic</a><ul>
<li><a class="reference internal" href="#display-pages-alternative">Display pages alternative</a></li>
<li><a class="reference internal" href="#send-udp-commands">Send UDP commands</a></li>
<li><a class="reference internal" href="#custom-uart-text-sensor">Custom UART Text Sensor</a></li>
<li><a class="reference internal" href="#custom-uart-switch">Custom UART Switch</a></li>
<li><a class="reference internal" href="#delaying-remote-transmissions">Delaying Remote Transmissions</a></li>
<li><a class="reference internal" href="#one-button-cover-control">One Button Cover Control</a></li>
<li><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
</ul>

  </div><hr />
<ul>
    <li><a href="https://discord.gg/KhAMKrd" target="_blank">Join the community</a></li>
    <li><a href="https://twitter.com/esphome_" target="_blank">Follow us on Twitter</a></li>
    <li><a href="https://github.com/esphome/esphome" target="_blank">Source Code</a></li>
    <li><a href="mailto:esphome@nabucasa.com">Contact</a> (no support!)</li>
</ul>
ESPHome is an open source project by <a href="https://www.nabucasa.com" target="_blank">Nabu Casa</a>
<ul>
    <li><a href="https://www.netlify.com" target="_blank">This site is powered by Netlify</a></li>
</ul>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
  
  <ul class="breadcrumbs">
      <li><a href="index.html">Cookbook</a> âž”</li>
      <li>Lambda Magic</li>
  </ul>
  


          <div class="body" role="main">
            
  <section id="lambda-magic">
<h1>Lambda Magic<a class="headerlink" href="#lambda-magic" title="Permalink to this heading">Â¶</a></h1>
<p>Here are a couple recipes for various interesting things you can do with <a class="reference internal" href="../guides/automations.html#config-lambda"><span class="std std-ref">Lambdas</span></a> in ESPHome.
These things donâ€™t need external or custom components, and show how powerful <a class="reference internal" href="../guides/automations.html#config-lambda"><span class="std std-ref">Lambda</span></a> usage can be.</p>
<section id="display-pages-alternative">
<span id="lambda-magic-pages"></span><h2>Display pages alternative<a class="headerlink" href="#display-pages-alternative" title="Permalink to this heading">Â¶</a></h2>
<p>Some displays like <a class="reference internal" href="../components/display/lcd_display.html#lcd-pcf8574"><span class="std std-ref">lcd_pcf8574 Component</span></a> donâ€™t support pages natively, but you can easily implement them
using Lambdas:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">display</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lcd_pcf8574</span>
<span class="w">    </span><span class="nt">dimensions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20x4</span>
<span class="w">    </span><span class="nt">address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0x27</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lcd</span>
<span class="w">    </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">          </span><span class="no">switch (id(page)){</span>
<span class="w">            </span><span class="no">case 1:</span>
<span class="w">              </span><span class="no">it.print(0, 1, &quot;Page1&quot;);</span>
<span class="w">              </span><span class="no">break;</span>
<span class="w">            </span><span class="no">case 2:</span>
<span class="w">              </span><span class="no">it.print(0, 1, &quot;Page2&quot;);</span>
<span class="w">              </span><span class="no">break;</span>
<span class="w">            </span><span class="no">case 3:</span>
<span class="w">              </span><span class="no">it.print(0, 1, &quot;Page3&quot;);</span>
<span class="w">              </span><span class="no">break;</span>
<span class="w">          </span><span class="no">}</span>

<span class="nt">globals</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">page</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
<span class="w">  </span><span class="nt">initial_value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>

<span class="nt">interval</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5s</span>
<span class="w">  </span><span class="nt">then</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">        </span><span class="no">id(page) = (id(page) + 1);</span>
<span class="w">        </span><span class="no">if (id(page) &gt; 3) {</span>
<span class="w">          </span><span class="no">id(page) = 1;</span>
<span class="w">        </span><span class="no">}</span>
</pre></div>
</div>
</section>
<section id="send-udp-commands">
<span id="lambda-magic-udp-sender"></span><h2>Send UDP commands<a class="headerlink" href="#send-udp-commands" title="Permalink to this heading">Â¶</a></h2>
<p>There are various network devices which can be commanded with UDP packets containing command strings.
You can send such UDP commands from ESPHome using a Lambda in a script.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">script</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">send_udp</span>
<span class="w">  </span><span class="nt">parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
<span class="w">  </span><span class="nt">then</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">          </span><span class="no">int sock = ::socket(AF_INET, SOCK_DGRAM, 0);</span>
<span class="w">          </span><span class="no">struct sockaddr_in destination, source;</span>

<span class="w">          </span><span class="no">destination.sin_family = AF_INET;</span>
<span class="w">          </span><span class="no">destination.sin_port = htons(port);</span>
<span class="w">          </span><span class="no">destination.sin_addr.s_addr = inet_addr(host.c_str());</span>

<span class="w">          </span><span class="no">// you can remove the next 4 lines if you don&#39;t want to set the source port for outgoing packets</span>
<span class="w">          </span><span class="no">source.sin_family = AF_INET;</span>
<span class="w">          </span><span class="no">source.sin_addr.s_addr = htonl(INADDR_ANY);</span>
<span class="w">          </span><span class="no">source.sin_port = htons(64998);  // the source port number</span>
<span class="w">          </span><span class="no">bind(sock, (struct sockaddr*)&amp;source, sizeof(source));</span>

<span class="w">          </span><span class="no">int n_bytes = ::sendto(sock, msg.c_str(), msg.length(), 0, reinterpret_cast&lt;sockaddr*&gt;(&amp;destination), sizeof(destination));</span>
<span class="w">          </span><span class="no">ESP_LOGD(&quot;lambda&quot;, &quot;Sent %s to %s:%d in %d bytes&quot;, msg.c_str(), host.c_str(), port, n_bytes);</span>
<span class="w">          </span><span class="no">::close(sock);</span>

<span class="nt">button</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">button_udp_sender</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Send</span><span class="nv"> </span><span class="s">UDP</span><span class="nv"> </span><span class="s">Command&quot;</span>
<span class="w">  </span><span class="nt">on_press</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script.execute</span><span class="p">:</span>
<span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">send_udp</span>
<span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Hello</span><span class="nv"> </span><span class="s">World!&quot;</span>
<span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.10&quot;</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5000</span>
</pre></div>
</div>
<p>Tested on both <cite>arduino</cite> and <cite>esp-idf</cite> platforms.</p>
</section>
<section id="custom-uart-text-sensor">
<span id="lambda-magic-uart-text-sensor"></span><h2>Custom UART Text Sensor<a class="headerlink" href="#custom-uart-text-sensor" title="Permalink to this heading">Â¶</a></h2>
<p>Lots of devices communicate using the UART protocol. If you want to read
lines from uart to a Text Sensor you can do so using this code example.</p>
<p>With this you can use automations or lambda to set switch or sensor states.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;esphome.h&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">UartReadLineSensor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">UARTDevice</span><span class="p">,</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">TextSensor</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">UartReadLineSensor</span><span class="p">(</span><span class="n">UARTComponent</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">UARTDevice</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">setup</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// nothing to do here</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">readline</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">readch</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">rpos</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">readch</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">readch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">:</span><span class="w"> </span><span class="c1">// Ignore new-lines</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;\r&#39;</span><span class="p">:</span><span class="w"> </span><span class="c1">// Return on CR</span>
<span class="w">          </span><span class="n">rpos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="w">          </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// Reset position index ready for next time</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">rpos</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="o">++</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">readch</span><span class="p">;</span>
<span class="w">            </span><span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// No end of line has been found, so return -1.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">loop</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_line_length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="n">max_line_length</span><span class="p">];</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">available</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">readline</span><span class="p">(</span><span class="n">read</span><span class="p">(),</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="n">max_line_length</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">publish_state</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>(Store this file in your configuration directory, for example <code class="docutils literal notranslate"><span class="pre">uart_read_line_sensor.h</span></code>)</p>
<p>And in YAML:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example configuration entry</span>
<span class="nt">esphome</span><span class="p">:</span>
<span class="w">  </span><span class="nt">includes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uart_read_line_sensor.h</span>

<span class="nt">logger</span><span class="p">:</span>
<span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VERBOSE</span><span class="w"> </span><span class="c1">#makes uart stream available in esphome logstream</span>
<span class="w">  </span><span class="nt">baud_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"> </span><span class="c1">#disable logging over uart</span>

<span class="nt">uart</span><span class="p">:</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uart_bus</span>
<span class="w">  </span><span class="nt">tx_pin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">D0</span>
<span class="w">  </span><span class="nt">rx_pin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">D1</span>
<span class="w">  </span><span class="nt">baud_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9600</span>

<span class="nt">text_sensor</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">custom</span>
<span class="w">  </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">    </span><span class="no">auto my_custom_sensor = new UartReadLineSensor(id(uart_bus));</span>
<span class="w">    </span><span class="no">App.register_component(my_custom_sensor);</span>
<span class="w">    </span><span class="no">return {my_custom_sensor};</span>
<span class="w">  </span><span class="nt">text_sensors</span><span class="p">:</span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;uart_readline&quot;</span>
</pre></div>
</div>
<p>For more details see <a class="reference internal" href="../custom/uart.html"><span class="doc">Custom UART Device</span></a> and <a class="reference internal" href="../components/uart.html"><span class="doc">UART Bus</span></a>.</p>
</section>
<section id="custom-uart-switch">
<span id="lambda-magic-uart-switch"></span><h2>Custom UART Switch<a class="headerlink" href="#custom-uart-switch" title="Permalink to this heading">Â¶</a></h2>
<p>Here is an example switch using the uart text sensor above to set switch state.</p>
<p>Here we use interval to request status from the device. The response will be stored in uart text sensor.
Then the switch uses the text sensor state to publish its own state.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">switch</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Switch&quot;</span>
<span class="w">    </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">      </span><span class="no">if (id(uart_readline).state == &quot;*POW=ON#&quot;) {</span>
<span class="w">        </span><span class="no">return true;</span>
<span class="w">      </span><span class="no">} else if(id(uart_readline).state == &quot;*POW=OFF#&quot;) {</span>
<span class="w">        </span><span class="no">return false;</span>
<span class="w">      </span><span class="no">} else {</span>
<span class="w">        </span><span class="no">return {};</span>
<span class="w">      </span><span class="no">}</span>
<span class="w">    </span><span class="nt">turn_on_action</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uart.write</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;\r*pow=on#\r&quot;</span>
<span class="w">    </span><span class="nt">turn_off_action</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uart.write</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;\r*pow=off#\r&quot;</span>

<span class="nt">interval</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">    </span><span class="nt">then</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">uart.write</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;\r*pow=?#\r&quot;</span>
</pre></div>
</div>
</section>
<section id="delaying-remote-transmissions">
<span id="lambda-magic-rf-queues"></span><h2>Delaying Remote Transmissions<a class="headerlink" href="#delaying-remote-transmissions" title="Permalink to this heading">Â¶</a></h2>
<p>The solution below handles the problem of RF frames being sent out by <a class="reference internal" href="../components/rf_bridge.html"><span class="doc">RF Bridge Component</span></a> (or
<a class="reference internal" href="../components/remote_transmitter.html"><span class="doc">Remote Transmitter</span></a>) too quickly one after another when operating radio controlled
covers. The cover motors seem to need at least 600-700ms of silence between the individual code transmissions
to be able to recognize them.</p>
<p>This can be solved by building up a queue of raw RF codes and sending them out one after the other with
(a configurable) delay between them. Delay is only added to the next commands coming from a list of
covers which have to be operated at once from Home Assistant. This is transparent to the system, which
will still look like they operate simultaneously.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">rf_bridge</span><span class="p">:</span>

<span class="nt">number</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">template</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Delay commands</span>
<span class="w">  </span><span class="nt">icon</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mdi:clock-fast</span>
<span class="w">  </span><span class="nt">entity_category</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config</span>
<span class="w">  </span><span class="nt">optimistic</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">restore_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">initial_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">750</span>
<span class="w">  </span><span class="nt">unit_of_measurement</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ms&quot;</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">queue_delay</span>
<span class="w">  </span><span class="nt">min_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">  </span><span class="nt">max_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">  </span><span class="nt">step</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">box</span>

<span class="nt">globals</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rf_code_queue</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;std::vector&lt;std::string&gt;&#39;</span>

<span class="nt">script</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rf_transmitter_queue</span>
<span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">single</span>
<span class="w">  </span><span class="nt">then</span><span class="p">:</span>
<span class="w">    </span><span class="nt">while</span><span class="p">:</span>
<span class="w">      </span><span class="nt">condition</span><span class="p">:</span>
<span class="w">        </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;return</span><span class="nv"> </span><span class="s">!id(rf_code_queue).empty();&#39;</span>
<span class="w">      </span><span class="nt">then</span><span class="p">:</span>
<span class="w">         </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">rf_bridge.send_raw</span><span class="p">:</span>
<span class="w">             </span><span class="nt">raw</span><span class="p">:</span><span class="w"> </span><span class="kt">!lambda</span><span class="w"> </span><span class="p p-Indicator">|-</span>
<span class="w">               </span><span class="no">std::string rf_code = id(rf_code_queue).front();</span>
<span class="w">               </span><span class="no">id(rf_code_queue).erase(id(rf_code_queue).begin());</span>
<span class="w">               </span><span class="no">return rf_code;</span>
<span class="w">         </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">delay</span><span class="p">:</span><span class="w"> </span><span class="kt">!lambda</span><span class="w"> </span><span class="s">&#39;return</span><span class="nv"> </span><span class="s">id(queue_delay).state;&#39;</span>

<span class="nt">cover</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># have multiple covers</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time_based</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;My</span><span class="nv"> </span><span class="s">Room</span><span class="nv"> </span><span class="s">1&#39;</span>
<span class="w">    </span><span class="nt">disabled_by_default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">device_class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shutter</span>
<span class="w">    </span><span class="nt">assumed_state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">has_built_in_endstop</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">    </span><span class="nt">close_action</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id(rf_code_queue).push_back(&quot;AAB0XXXXX..the.closing.code..XXXXXXXXXX&quot;);</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script.execute</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rf_transmitter_queue</span>
<span class="w">    </span><span class="nt">close_duration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">26s</span>

<span class="w">    </span><span class="nt">stop_action</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id(rf_code_queue).push_back(&quot;AAB0YXXXX..the.stopping.code..XXXXXXXXXX&quot;);</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script.execute</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rf_transmitter_queue</span>

<span class="w">    </span><span class="nt">open_action</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id(rf_code_queue).push_back(&quot;AAB0ZXXXX..the.opening.code..XXXXXXXXXX&quot;);</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">script.execute</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rf_transmitter_queue</span>
<span class="w">    </span><span class="nt">open_duration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27s</span>
</pre></div>
</div>
</section>
<section id="one-button-cover-control">
<span id="lambda-magic-1button-coover"></span><h2>One Button Cover Control<a class="headerlink" href="#one-button-cover-control" title="Permalink to this heading">Â¶</a></h2>
<p>The configuration below shows how with a single button you can control the motion of a motorized cover
by cycling between: open-&gt;stop-&gt;close-&gt;stop-&gt;â€¦</p>
<p>In this example a <a class="reference internal" href="../components/cover/time_based.html"><span class="doc">Time Based Cover</span></a> is used with the GPIO configuration of a Sonoff Dual R2.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Controlling the cover to quickly (sending new open/close commands within a minute of previous commands)
might cause unexpected behaviour (eg: cover stopping halfway). This is because the delayed relay off
feature is implemented using asynchronous automations. So every time an open/close command is sent a
delayed relay off command is added and old ones are not removed.</p>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">esp8266</span><span class="p">:</span>
<span class="w">  </span><span class="nt">board</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">esp01_1m</span>

<span class="nt">binary_sensor</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpio</span>
<span class="w">  </span><span class="nt">pin</span><span class="p">:</span>
<span class="w">    </span><span class="nt">number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GPIO10</span>
<span class="w">    </span><span class="nt">inverted</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">button</span>
<span class="w">  </span><span class="nt">on_press</span><span class="p">:</span>
<span class="w">    </span><span class="nt">then</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># logic for cycling through movements: open-&gt;stop-&gt;close-&gt;stop-&gt;...</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lambda</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">if (id(my_cover).current_operation == COVER_OPERATION_IDLE) {</span>
<span class="w">            </span><span class="no">// Cover is idle, check current state and either open or close cover.</span>
<span class="w">            </span><span class="no">if (id(my_cover).is_fully_closed()) {</span>
<span class="w">              </span><span class="no">id(my_cover).open();</span>
<span class="w">            </span><span class="no">} else {</span>
<span class="w">              </span><span class="no">id(my_cover).close();</span>
<span class="w">            </span><span class="no">}</span>
<span class="w">          </span><span class="no">} else {</span>
<span class="w">            </span><span class="no">// Cover is opening/closing. Stop it.</span>
<span class="w">            </span><span class="no">id(my_cover).stop();</span>
<span class="w">          </span><span class="no">}</span>

<span class="nt">switch</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpio</span>
<span class="w">  </span><span class="nt">pin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GPIO12</span>
<span class="w">  </span><span class="nt">interlock</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;interlock</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">open_cover</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">close_cover</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">open_cover</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gpio</span>
<span class="w">  </span><span class="nt">pin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GPIO5</span>
<span class="w">  </span><span class="nt">interlock</span><span class="p">:</span><span class="w"> </span><span class="nv">*interlock</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">close_cover</span>

<span class="nt">cover</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">platform</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">time_based</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Cover&quot;</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my_cover</span>
<span class="w">  </span><span class="nt">open_action</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">switch.turn_on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">open_cover</span>
<span class="w">  </span><span class="nt">open_duration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
<span class="w">  </span><span class="nt">close_action</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">switch.turn_on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">close_cover</span>
<span class="w">  </span><span class="nt">close_duration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
<span class="w">  </span><span class="nt">stop_action</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">switch.turn_off</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">open_cover</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">switch.turn_off</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">close_cover</span>
</pre></div>
</div>
</section>
<section id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Permalink to this heading">Â¶</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../guides/automations.html#config-lambda"><span class="std std-ref">Templates (Lambdas)</span></a></p></li>
<li><p><a class="reference internal" href="../guides/automations.html#automation"><span class="std std-ref">Automations and Templates</span></a></p></li>
<li><p><a class="reference external" href="https://github.com/esphome/esphome-docs/blob/current/cookbook/lambda_magic.rst">Edit this page on GitHub</a></p></li>
</ul>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
  <div id="upgrade-footer">
    A new version has been release since you last visited this page: 2023.8.3 ðŸŽ‰
    <div class="footer-button-container">
      <div role="button" id="upgrade-footer-dismiss" class="footer-button">Dismiss</div>
      <a id="upgrade-footer-changelog" class="footer-button" href="changelog/2023.8.0.html">View Changelog</a>
    </div>
  </div>
  <script>
    var old = window.localStorage.getItem("version");
    if (old === null || window.location.pathname.lastIndexOf("changelog/", 0) === 0) { window.localStorage.setItem("version", "2023.8");
    } else if (old !== "2023.8") {
      const footerEl = document.getElementById("upgrade-footer");
      footerEl.classList.add("not-hidden");
      footerEl.addEventListener('click', function () {
        window.localStorage.setItem("version", "2023.8");
        footerEl.classList.remove("not-hidden");
      });
    }
  </script>

  </body>
</html>